<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocationController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenWMS.org COMMON: Base Service Library</a> &gt; <a href="index.source.html" class="el_package">org.openwms.common.location</a> &gt; <span class="el_source">LocationController.java</span></div><h1>LocationController.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2005-2024 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.openwms.common.location;

import org.ameba.exception.BusinessRuntimeException;
import org.ameba.exception.NotFoundException;
import org.ameba.http.MeasuredRestController;
import org.ameba.i18n.Translator;
import org.openwms.common.location.api.ErrorCodeVO;
import org.openwms.common.location.api.LocationVO;
import org.openwms.common.location.api.LockMode;
import org.openwms.common.location.api.LockType;
import org.openwms.common.location.api.ValidationGroups;
import org.openwms.core.http.AbstractWebController;
import org.openwms.core.http.Index;
import org.springframework.context.annotation.Profile;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PatchMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;

import javax.servlet.http.HttpServletRequest;
import javax.validation.Valid;
import java.io.Serializable;
import java.util.List;
import java.util.function.BiConsumer;

import static java.util.Arrays.asList;
import static org.openwms.common.CommonMessageCodes.LOCATION_ID_INVALID;
import static org.openwms.common.CommonMessageCodes.LOCATION_NOT_FOUND_BY_ERP_CODE;
import static org.openwms.common.CommonMessageCodes.LOCATION_NOT_FOUND_BY_ID;
import static org.openwms.common.CommonMessageCodes.LOCATION_NOT_FOUND_BY_PLC_CODE;
import static org.openwms.common.CommonMessageCodes.LOCK_MODE_UNSUPPORTED;
import static org.openwms.common.CommonMessageCodes.LOCK_TYPE_UNSUPPORTED;
import static org.openwms.common.location.api.LocationApiConstants.API_LOCATION;
import static org.openwms.common.location.api.LocationApiConstants.API_LOCATIONS;
import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.linkTo;
import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.methodOn;

/**
 * A LocationController.
 *
 * @author Heiko Scherrer
 */
@Profile(&quot;!INMEM&quot;)
@Validated
@MeasuredRestController
public class LocationController extends AbstractWebController {

    private final LocationMapper mapper;
    private final Translator translator;
    private final LocationService locationService;
    private final LocationRemovalManager locationRemovalManager;

<span class="fc" id="L76">    LocationController(LocationService locationService, LocationMapper mapper, Translator translator, LocationRemovalManager locationRemovalManager) {</span>
<span class="fc" id="L77">        this.locationService = locationService;</span>
<span class="fc" id="L78">        this.mapper = mapper;</span>
<span class="fc" id="L79">        this.translator = translator;</span>
<span class="fc" id="L80">        this.locationRemovalManager = locationRemovalManager;</span>
<span class="fc" id="L81">    }</span>

    @PostMapping(value = API_LOCATIONS)
    @Validated(ValidationGroups.Create.class)
    public ResponseEntity&lt;LocationVO&gt; createLocation(@Valid @RequestBody LocationVO location, HttpServletRequest req) {
<span class="nc" id="L86">        var created = locationService.create(mapper.convertVO(location));</span>
<span class="nc" id="L87">        var result = mapper.convertToVO(created);</span>
<span class="nc" id="L88">        addSelfLink(result);</span>
<span class="nc" id="L89">        return ResponseEntity</span>
<span class="nc" id="L90">                .created(super.getLocationURIForCreatedResource(req, created.getPersistentKey()))</span>
<span class="nc" id="L91">                .header(HttpHeaders.CONTENT_TYPE, LocationVO.MEDIA_TYPE)</span>
<span class="nc" id="L92">                .body(result);</span>
    }

    @PutMapping(value = API_LOCATIONS)
    @Validated(ValidationGroups.Update.class)
    public ResponseEntity&lt;LocationVO&gt; updateLocation(@Valid @RequestBody LocationVO location) {
<span class="nc" id="L98">        var updated = locationService.save(mapper.convertVO(location));</span>
<span class="nc" id="L99">        var result = mapper.convertToVO(updated);</span>
<span class="nc" id="L100">        addSelfLink(result);</span>
<span class="nc" id="L101">        return ResponseEntity.status(HttpStatus.OK).header(HttpHeaders.CONTENT_TYPE, LocationVO.MEDIA_TYPE).body(result);</span>
    }

    @DeleteMapping(value = API_LOCATIONS + &quot;/{pKey}&quot;)
    public ResponseEntity&lt;Void&gt; deleteLocation(@PathVariable(&quot;pKey&quot;) String pKey) {
<span class="nc" id="L106">        locationRemovalManager.tryDelete(pKey);</span>
<span class="nc" id="L107">        return ResponseEntity.noContent().build();</span>
    }

    @GetMapping(value = API_LOCATIONS + &quot;/{pKey}&quot;)
    public ResponseEntity&lt;LocationVO&gt; findByPKey(@PathVariable(&quot;pKey&quot;) String pKey) {
<span class="nc" id="L112">        var location = locationService.findByPKey(pKey);</span>
<span class="nc" id="L113">        var result = mapper.convertToVO(location);</span>
<span class="nc" id="L114">        addSelfLink(result);</span>
<span class="nc" id="L115">        return ResponseEntity.status(HttpStatus.OK).header(HttpHeaders.CONTENT_TYPE, LocationVO.MEDIA_TYPE).body(result);</span>
    }

    private void addSelfLink(LocationVO result) {
<span class="nc" id="L119">        result.add(linkTo(methodOn(LocationController.class).findByPKey(result.getpKey())).withRel(&quot;location-findbypkey&quot;));</span>
<span class="nc" id="L120">    }</span>

    @GetMapping(value = API_LOCATIONS, params = {&quot;locationId&quot;})
    public ResponseEntity&lt;LocationVO&gt; findByCoordinate(@RequestParam(&quot;locationId&quot;) String locationId) {
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (!LocationPK.isValid(locationId)) {</span>
            // here we need to throw an NFE because Feign needs to cast it into an Optional. IAE won't work!
<span class="nc" id="L126">            throw new NotFoundException(translator, LOCATION_ID_INVALID, new String[]{locationId}, locationId);</span>
        }
<span class="nc" id="L128">        var location = locationService.findByLocationPk(LocationPK.fromString(locationId))</span>
<span class="nc" id="L129">                .orElseThrow(() -&gt; new NotFoundException(</span>
                        translator,
                        LOCATION_NOT_FOUND_BY_ID,
                        new String[]{locationId},
                        locationId
                ));
<span class="nc" id="L135">        var result = mapper.convertToVO(location);</span>
<span class="nc" id="L136">        addSelfLink(result);</span>
<span class="nc" id="L137">        return ResponseEntity.status(HttpStatus.OK).header(HttpHeaders.CONTENT_TYPE, LocationVO.MEDIA_TYPE).body(result);</span>
    }

    @GetMapping(value = API_LOCATIONS, params = {&quot;erpCode&quot;})
    public ResponseEntity&lt;LocationVO&gt; findByErpCode(@RequestParam(&quot;erpCode&quot;) String erpCode) {
<span class="nc" id="L142">        var location = locationService.findByErpCode(erpCode).orElseThrow(() -&gt; locationNotFound(erpCode));</span>
<span class="nc" id="L143">        var result = mapper.convertToVO(location);</span>
<span class="nc" id="L144">        addSelfLink(result);</span>
<span class="nc" id="L145">        return ResponseEntity.status(HttpStatus.OK).header(HttpHeaders.CONTENT_TYPE, LocationVO.MEDIA_TYPE).body(result);</span>
    }

    @GetMapping(value = API_LOCATIONS, params = {&quot;plcCode&quot;})
    public ResponseEntity&lt;LocationVO&gt; findByPlcCode(@RequestParam(&quot;plcCode&quot;) String plcCode) {
<span class="nc" id="L150">        var location = locationService.findByPlcCode(plcCode)</span>
<span class="nc" id="L151">                .orElseThrow(() -&gt; new NotFoundException(</span>
                        translator,
                        LOCATION_NOT_FOUND_BY_PLC_CODE,
                        new String[]{plcCode},
                        plcCode
                ));
<span class="nc" id="L157">        var result = mapper.convertToVO(location);</span>
<span class="nc" id="L158">        addSelfLink(result);</span>
<span class="nc" id="L159">        return ResponseEntity.status(HttpStatus.OK).header(HttpHeaders.CONTENT_TYPE, LocationVO.MEDIA_TYPE).body(result);</span>
    }

    @GetMapping(value = API_LOCATIONS, params = {&quot;locationGroupNames&quot;})
    public ResponseEntity&lt;List&lt;LocationVO&gt;&gt; findForLocationGroups(
            @RequestParam(&quot;locationGroupNames&quot;) List&lt;String&gt; locationGroupNames) {
<span class="nc" id="L165">        var locations = locationService.findAllOf(locationGroupNames);</span>
<span class="nc" id="L166">        var result = mapper.convertToVO(locations);</span>
<span class="nc" id="L167">        result.forEach(this::addSelfLink);</span>
<span class="nc" id="L168">        return ResponseEntity.status(HttpStatus.OK).header(HttpHeaders.CONTENT_TYPE, LocationVO.MEDIA_TYPE).body(result);</span>
    }

    @PatchMapping(value = API_LOCATION + &quot;/{pKey}&quot;, params = &quot;op=change-state&quot;)
    public ResponseEntity&lt;Void&gt; changeState(
            @PathVariable(name = &quot;pKey&quot;) String pKey,
            @RequestParam(name = &quot;op&quot;) String op,
            @RequestBody ErrorCodeVO errorCode
    ) {
<span class="nc" id="L177">        locationService.changeState(pKey, errorCode);</span>
<span class="nc" id="L178">        return ResponseEntity.noContent().build();</span>
    }

    @PatchMapping(value = API_LOCATION, params = {&quot;locationId&quot;, &quot;op=change-state&quot;})
    public ResponseEntity&lt;Void&gt; changeState(
            @RequestParam(name = &quot;locationId&quot;) String locationId,
            @RequestBody ErrorCodeVO errorCode
    ) {
<span class="nc" id="L186">        locationService.changeState(LocationPK.fromString(locationId), errorCode);</span>
<span class="nc" id="L187">        return ResponseEntity.noContent().build();</span>
    }

    /**
     * Change the current {@code mode} a {@code Location}, identified by {@code erpCode}.
     *
     * @param erpCode The ERP code of the Location
     * @param type The type of lock to apply to the Location
     * @param mode The mode to apply to the Locations lock
     */
    @PostMapping(path = API_LOCATIONS , params = {&quot;erpCode&quot;, &quot;type!=PERMANENT_LOCK&quot;, &quot;mode&quot;})
    public ResponseEntity&lt;Void&gt; changeState(
            @RequestParam(&quot;erpCode&quot;) String erpCode,
            @RequestParam(&quot;type&quot;) LockType type,
            @RequestParam(&quot;mode&quot;) LockMode mode,
            @RequestParam(value = &quot;plcState&quot;, required = false) Integer plcState
    ) {
<span class="nc" id="L204">        var location = locationService.findByErpCode(erpCode).orElseThrow(() -&gt; locationNotFound(erpCode));</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (type == LockType.ALLOCATION_LOCK) {</span>
<span class="nc" id="L206">            changeLocation(</span>
                    mode,
                    location,
                    plcState,
<span class="nc" id="L210">                    (l, code) -&gt; locationService.changeState(l.getPersistentKey(), code)</span>
            );
        } else {
<span class="nc" id="L213">            unsupportedOperation(type);</span>
        }
<span class="nc" id="L215">        return ResponseEntity.noContent().build();</span>
    }

    @GetMapping(API_LOCATIONS)
    public ResponseEntity&lt;List&lt;LocationVO&gt;&gt; findByCoordinate(
            @RequestParam(value = &quot;area&quot;, required = false, defaultValue = &quot;%&quot;) String area,
            @RequestParam(value = &quot;aisle&quot;, required = false, defaultValue = &quot;%&quot;) String aisle,
            @RequestParam(value = &quot;x&quot;, required = false, defaultValue = &quot;%&quot;) String x,
            @RequestParam(value = &quot;y&quot;, required = false, defaultValue = &quot;%&quot;) String y,
            @RequestParam(value = &quot;z&quot;, required = false, defaultValue = &quot;%&quot;) String z
    ) {
<span class="nc" id="L226">        var pk = LocationPK.of(area, aisle, x, y, z);</span>
<span class="nc" id="L227">        var result = mapper.convertToVO(locationService.findLocations(pk));</span>
<span class="nc" id="L228">        result.forEach(this::addSelfLink);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">        return result.isEmpty()</span>
<span class="nc" id="L230">                ? ResponseEntity.notFound().build()</span>
<span class="nc" id="L231">                : ResponseEntity.status(HttpStatus.OK).header(HttpHeaders.CONTENT_TYPE, LocationVO.MEDIA_TYPE).body(result);</span>
    }

    @GetMapping(API_LOCATIONS + &quot;/index&quot;)
    public ResponseEntity&lt;Index&gt; index() {
<span class="nc" id="L236">        return ResponseEntity.ok(</span>
                new Index(
<span class="nc" id="L238">                        linkTo(methodOn(LocationController.class).createLocation(new LocationVO(&quot;locationId&quot;), null)).withRel(&quot;location-create&quot;),</span>
<span class="nc" id="L239">                        linkTo(methodOn(LocationController.class).updateLocation(new LocationVO(&quot;locationId&quot;))).withRel(&quot;location-updatelocation&quot;),</span>
<span class="nc" id="L240">                        linkTo(methodOn(LocationController.class).deleteLocation(&quot;pKey&quot;)).withRel(&quot;location-deletelocation&quot;),</span>
<span class="nc" id="L241">                        linkTo(methodOn(LocationController.class).findByPKey(&quot;pKey&quot;)).withRel(&quot;location-findbypkey&quot;),</span>
<span class="nc" id="L242">                        linkTo(methodOn(LocationController.class).findByCoordinate(&quot;AREA/AISLE/X/Y/Z&quot;)).withRel(&quot;location-findbycoordinate&quot;),</span>
<span class="nc" id="L243">                        linkTo(methodOn(LocationController.class).findByCoordinate(&quot;area&quot;, &quot;aisle&quot;, &quot;x&quot;, &quot;y&quot;, &quot;z&quot;)).withRel(&quot;location-findbycoordinate-wc&quot;),</span>
<span class="nc" id="L244">                        linkTo(methodOn(LocationController.class).findByErpCode(&quot;ERP_CODE&quot;)).withRel(&quot;location-findbyerpcode&quot;),</span>
<span class="nc" id="L245">                        linkTo(methodOn(LocationController.class).findByPlcCode(&quot;PLC_CODE&quot;)).withRel(&quot;location-findbyplccode&quot;),</span>
<span class="nc" id="L246">                        linkTo(methodOn(LocationController.class).findForLocationGroups(asList(&quot;LG1&quot;, &quot;LG2&quot;))).withRel(&quot;location-forlocationgroup&quot;),</span>
<span class="nc" id="L247">                        linkTo(methodOn(LocationController.class).changeState(&quot;pKey&quot;, &quot;change-state&quot;, ErrorCodeVO.LOCK_STATE_IN_AND_OUT)).withRel(&quot;location-changestate&quot;)</span>
                )
        );
    }

    private void changeLocation(LockMode mode, Target target, Integer plcState, BiConsumer&lt;Target, ErrorCodeVO&gt; fnc) {
        ErrorCodeVO state;
<span class="nc bnc" id="L254" title="All 5 branches missed.">        switch (mode) {</span>
            case IN -&gt; {
<span class="nc" id="L256">                state = ErrorCodeVO.LOCK_STATE_IN;</span>
<span class="nc" id="L257">                state.setPlcState(plcState);</span>
<span class="nc" id="L258">                fnc.accept(target, state);</span>
<span class="nc" id="L259">            }</span>
            case OUT -&gt; {
<span class="nc" id="L261">                state = ErrorCodeVO.LOCK_STATE_OUT;</span>
<span class="nc" id="L262">                state.setPlcState(plcState);</span>
<span class="nc" id="L263">                fnc.accept(target, state);</span>
<span class="nc" id="L264">            }</span>
            case IN_AND_OUT -&gt; {
<span class="nc" id="L266">                state = ErrorCodeVO.LOCK_STATE_IN_AND_OUT;</span>
<span class="nc" id="L267">                state.setPlcState(plcState);</span>
<span class="nc" id="L268">                fnc.accept(target, state);</span>
<span class="nc" id="L269">            }</span>
            case NONE -&gt; {
<span class="nc" id="L271">                state = ErrorCodeVO.UNLOCK_STATE_IN_AND_OUT;</span>
<span class="nc" id="L272">                state.setPlcState(plcState);</span>
<span class="nc" id="L273">                fnc.accept(target, state);</span>
<span class="nc" id="L274">            }</span>
<span class="nc" id="L275">            default -&gt; unsupportedOperation(mode);</span>
        }
<span class="nc" id="L277">    }</span>

    private NotFoundException locationNotFound(String erpCode) {
<span class="nc" id="L280">        return new NotFoundException(translator, LOCATION_NOT_FOUND_BY_ERP_CODE, new String[]{erpCode}, erpCode);</span>
    }

    private void unsupportedOperation(LockMode mode) {
<span class="nc" id="L284">        throw new BusinessRuntimeException(translator, LOCK_MODE_UNSUPPORTED, new Serializable[]{mode}, mode);</span>
    }

    private void unsupportedOperation(LockType type) {
<span class="nc" id="L288">        throw new BusinessRuntimeException(translator, LOCK_TYPE_UNSUPPORTED, new Serializable[]{type}, type);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>